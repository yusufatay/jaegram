#!/usr/bin/env python3
"""
Enhanced Notification System Demo
Creates test data and demonstrates all notification features
"""

import requests
import json
import asyncio
import websockets
import sqlite3
from datetime import datetime, timedelta

# Configuration
BASE_URL = "http://localhost:8000"
WS_URL = "ws://localhost:8000"
DB_PATH = "/home/mirza/Desktop/instagram_puan_iskelet/backend/instagram_platform.db"

class NotificationDemo:
    def __init__(self):
        self.token = None
        self.user_id = None
        self.headers = {}
        self.received_notifications = []
        
    def login(self):
        """Login and get authentication token"""
        print("üîê Logging in...")
        response = requests.post(f"{BASE_URL}/login", data={
            'username': 'luvmef',
            'password': 'asgsag2'
        })
        
        if response.status_code == 200:
            data = response.json()
            self.token = data['access_token']
            self.headers = {'Authorization': f'Bearer {self.token}'}
            
            # Get user profile
            profile = requests.get(f"{BASE_URL}/profile", headers=self.headers)
            if profile.status_code == 200:
                user_data = profile.json()
                self.user_id = user_data['id']
                print(f"‚úÖ Logged in as: {user_data['username']} (ID: {self.user_id})")
                return True
        
        print(f"‚ùå Login failed")
        return False
    
    def create_demo_data(self):
        """Create demo orders and tasks in database"""
        try:
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            
            print("üóÉÔ∏è  Creating demo test data...")
            
            # Create a test order (not from our user)
            cursor.execute("""
                INSERT INTO orders (user_id, post_url, order_type, target_count, status, created_at)
                VALUES (2, 'https://www.instagram.com/p/demo123/', 'like', 10, 'active', ?)
            """, (datetime.now(),))
            
            order_id = cursor.lastrowid
            
            # Create several tasks for this order
            for i in range(3):
                cursor.execute("""
                    INSERT INTO tasks (order_id, status)
                    VALUES (?, 'pending')
                """, (order_id,))
            
            # Reset user's daily reward to allow claiming
            yesterday = datetime.now() - timedelta(days=1)
            cursor.execute("""
                UPDATE users 
                SET last_daily_reward = ?, daily_reward_streak = 2
                WHERE id = ?
            """, (yesterday, self.user_id))
            
            conn.commit()
            conn.close()
            
            print(f"‚úÖ Created demo order {order_id} with 3 tasks")
            return order_id
            
        except Exception as e:
            print(f"‚ùå Failed to create demo data: {e}")
            return None
    
    async def websocket_listener(self):
        """Listen for real-time notifications"""
        try:
            uri = f"{WS_URL}/ws/notifications?token={self.token}"
            
            async with websockets.connect(uri) as websocket:
                print("üîå WebSocket connected - listening for notifications...")
                
                async for message in websocket:
                    try:
                        notification = json.loads(message)
                        self.received_notifications.append(notification)
                        
                        print(f"üì° REAL-TIME NOTIFICATION:")
                        print(f"   Type: {notification.get('type', 'unknown')}")
                        
                        if 'notification' in notification:
                            notif = notification['notification']
                            title = notif.get('title', 'No title')
                            message = notif.get('message', 'No message')
                            priority = notif.get('priority', 'unknown')
                            category = notif.get('category', 'unknown')
                            
                            print(f"   üéØ Title: {title}")
                            print(f"   üí¨ Message: {message}")
                            print(f"   ‚ö° Priority: {priority}")
                            print(f"   üìÇ Category: {category}")
                        
                        print(f"   üïê Timestamp: {notification.get('timestamp', 'unknown')}")
                        print("-" * 60)
                        
                    except json.JSONDecodeError as e:
                        print(f"‚ùå Failed to parse notification: {e}")
                        
        except Exception as e:
            print(f"‚ùå WebSocket error: {e}")
    
    async def demo_workflow(self):
        """Demonstrate the complete notification workflow"""
        print("üöÄ Enhanced Notification System DEMO")
        print("=" * 60)
        
        # Login
        if not self.login():
            return
        
        # Create demo data
        order_id = self.create_demo_data()
        if not order_id:
            return
        
        print()
        
        # Start WebSocket listener
        websocket_task = asyncio.create_task(self.websocket_listener())
        await asyncio.sleep(2)  # Let WebSocket connect
        
        print("üé¨ Starting notification demo workflow...")
        print()
        
        # Demo 1: Daily Reward Notification
        print("üéÅ DEMO 1: Daily Reward with Streak Notifications")
        reward_response = requests.post(f"{BASE_URL}/claim-daily-reward", headers=self.headers)
        if reward_response.status_code == 200:
            reward = reward_response.json()
            print(f"‚úÖ Daily reward claimed: {reward['coins_awarded']} coins (Streak: {reward['streak_day']})")
        print()
        
        await asyncio.sleep(3)  # Wait for notifications
        
        # Demo 2: Task Assignment Notification
        print("üéØ DEMO 2: Task Assignment Notification")
        task_response = requests.post(f"{BASE_URL}/take-task", headers=self.headers)
        if task_response.status_code == 200:
            task_data = task_response.json()
            print(f"‚úÖ Task assigned: ID {task_data['task_id']}")
            
            await asyncio.sleep(3)  # Wait for notifications
            
            # Demo 3: Task Completion with Level-up and Achievement
            print("üèÜ DEMO 3: Task Completion with Achievement Notifications")
            completion_response = requests.post(f"{BASE_URL}/complete-task", 
                                               headers=self.headers,
                                               json={"task_id": task_data['task_id']})
            if completion_response.status_code == 200:
                result = completion_response.json()
                print(f"‚úÖ Task completed: {result.get('message', 'No message')}")
                
                await asyncio.sleep(5)  # Wait for all completion notifications
            
        print()
        
        # Demo 4: Take and complete another task for more achievements
        print("üéØ DEMO 4: Second Task for Achievement Progression")
        task_response2 = requests.post(f"{BASE_URL}/take-task", headers=self.headers)
        if task_response2.status_code == 200:
            task_data2 = task_response2.json()
            print(f"‚úÖ Second task assigned: ID {task_data2['task_id']}")
            
            await asyncio.sleep(2)
            
            completion_response2 = requests.post(f"{BASE_URL}/complete-task", 
                                                headers=self.headers,
                                                json={"task_id": task_data2['task_id']})
            if completion_response2.status_code == 200:
                result2 = completion_response2.json()
                print(f"‚úÖ Second task completed: {result2.get('message', 'No message')}")
                
                await asyncio.sleep(3)
        
        print()
        
        # Demo 5: Check final stats
        print("üìä DEMO 5: Final Notification Statistics")
        stats_response = requests.get(f"{BASE_URL}/notification-stats", headers=self.headers)
        if stats_response.status_code == 200:
            stats = stats_response.json()
            print(f"üìà Total notifications: {stats['total_notifications']}")
            print(f"üì¨ Unread count: {stats['unread_count']}")
            print(f"üìã Types breakdown: {stats['notification_types']}")
        
        print()
        
        # Demo 6: Final profile
        print("üë§ Final Profile Status:")
        profile = requests.get(f"{BASE_URL}/profile", headers=self.headers)
        if profile.status_code == 200:
            user_data = profile.json()
            print(f"üí∞ Balance: {user_data['coin_balance']} coins")
            print(f"‚úÖ Completed tasks: {user_data['completed_tasks']}")
            print(f"üéØ Active tasks: {user_data['active_tasks']}")
        
        print()
        print("üé¨ DEMO SUMMARY:")
        print("=" * 60)
        
        # Categorize notifications
        connection_notifs = 0
        task_notifs = 0
        reward_notifs = 0
        achievement_notifs = 0
        level_notifs = 0
        
        for notif in self.received_notifications:
            notif_data = notif.get('notification', {})
            title = notif_data.get('title', '').lower()
            
            if 'ger√ßek zamanlƒ±' in title:
                connection_notifs += 1
            elif 'g√∂rev' in title:
                task_notifs += 1
            elif 'g√ºnl√ºk' in title or 'bonus' in title:
                reward_notifs += 1
            elif 'seviye' in title or 'level' in title:
                level_notifs += 1
            elif 'tebrikler' in title or 'ba≈üarƒ±' in title:
                achievement_notifs += 1
        
        print(f"üì° Real-time Notifications Received: {len(self.received_notifications)}")
        print(f"   üîå Connection notifications: {connection_notifs}")
        print(f"   üéØ Task notifications: {task_notifs}")
        print(f"   üéÅ Reward notifications: {reward_notifs}")
        print(f"   üìà Level-up notifications: {level_notifs}")
        print(f"   üèÜ Achievement notifications: {achievement_notifs}")
        
        print()
        print("üìã All Notifications Received:")
        for i, notif in enumerate(self.received_notifications):
            notif_data = notif.get('notification', {})
            title = notif_data.get('title', 'No title')
            priority = notif_data.get('priority', 'unknown')
            print(f"   {i+1}. {title} (Priority: {priority})")
        
        print()
        print("‚úÖ Enhanced Notification System Demo Complete!")
        print("üéâ All notification types working perfectly!")
        
        # Cancel WebSocket
        websocket_task.cancel()

def main():
    demo = NotificationDemo()
    asyncio.run(demo.demo_workflow())

if __name__ == "__main__":
    main()
